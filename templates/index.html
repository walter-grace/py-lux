<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Finder - Compare Prices Across Platforms</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .search-section {
            padding: 40px;
            background: #f8f9fa;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-form input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .search-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-form button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .search-form button:hover {
            transform: translateY(-2px);
        }
        
        .search-form button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .option-group {
            flex: 1;
            min-width: 200px;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
        }
        
        .option-group input, .option-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .results-section {
            padding: 40px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        .loading-status {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
        
        .loading-status .status-item {
            margin: 5px 0;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 5px;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-searching {
            color: #667eea;
        }
        
        .status-success {
            color: #10b981;
        }
        
        .status-error {
            color: #ef4444;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .platform-section {
            margin-bottom: 40px;
        }
        
        .platform-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .platform-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }
        
        .badge-ebay {
            background: #3b82f6;
        }
        
        .badge-facebook {
            background: #1877f2;
        }
        
        .badge-amazon {
            background: #ff9900;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .item-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }
        
        .item-info {
            padding: 15px;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 0.95em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .item-price {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .item-link {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        
        .item-link:hover {
            background: #5568d3;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .generate-report {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        .generate-report button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .generate-report button:hover {
            transform: translateY(-2px);
        }
        
        .generate-report button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #666;
        }
        
        .comparison-table td img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: transform 0.2s;
        }
        
        .comparison-table td img:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .best-price {
            background: #d1fae5;
            font-weight: bold;
        }
        
        .trending-section {
            padding: 40px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }
        
        .trending-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .trending-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .trending-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .trending-item-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 0.9em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .trending-item-price {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .trending-item-rank {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .search-from-trending {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .search-from-trending:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Arbitrage Finder</h1>
            <p>Compare prices across eBay, Facebook Marketplace, and Amazon</p>
        </div>
        
        <div class="search-section">
            <form class="search-form" id="searchForm">
                <input type="text" id="searchQuery" placeholder="Enter product name (e.g., 'Gucci boots', 'iPhone 15', 'Nike sneakers')" required>
                <button type="submit" id="searchBtn">Search</button>
            </form>
            
            <div class="options">
                <div class="option-group">
                    <label for="maxResults">Max Results per Platform:</label>
                    <input type="number" id="maxResults" value="20" min="1" max="50">
                </div>
                <div class="option-group">
                    <label for="location">Location (for Facebook - Optional):</label>
                    <input type="text" id="location" value="Los Angeles, CA" placeholder="City, State (optional)">
                </div>
            </div>
        </div>
        
        <div class="trending-section" id="trendingSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üî• Trending Items on Amazon</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="trendingCategory" style="margin: 0; font-weight: 500;">Category:</label>
                    <select id="trendingCategory" onchange="loadTrending()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="electronics">Electronics</option>
                        <option value="fashion">Fashion</option>
                        <option value="mobile-apps">Mobile Apps</option>
                        <option value="books">Books</option>
                        <option value="home-garden">Home & Garden</option>
                        <option value="beauty">Beauty</option>
                        <option value="automotive">Automotive</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="pet-supplies">Pet Supplies</option>
                        <option value="musical-instruments">Musical Instruments</option>
                        <option value="office-products">Office Products</option>
                    </select>
                </div>
            </div>
            <div id="trendingItems" class="trending-items">
                <div class="loading" style="padding: 20px; text-align: center; color: #666;">
                    Loading trending items...
                </div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <div id="dataQualityWarnings" style="display: none;"></div>
            <div id="stats"></div>
            <div id="errors"></div>
            <div id="results"></div>
            <div class="generate-report">
                <button id="generateReportBtn" onclick="generateReport()">Generate HTML Report</button>
            </div>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Searching eBay, Facebook Marketplace, and Amazon...</p>
            <div class="loading-status" id="loadingStatus">
                <span class="status-item status-searching" id="statusEbay">üîç Searching eBay...</span>
                <span class="status-item status-searching" id="statusFacebook">üîç Searching Facebook...</span>
                <span class="status-item status-searching" id="statusAmazon">üîç Searching Amazon...</span>
            </div>
        </div>
    </div>
    
    <script>
        let searchResults = null;
        
        // Load trending items on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadTrending();
        });
        
        async function loadTrending() {
            const category = document.getElementById('trendingCategory').value;
            const container = document.getElementById('trendingItems');
            
            container.innerHTML = '<div class="loading" style="padding: 20px; text-align: center; color: #666;">Loading trending items...</div>';
            
            try {
                const response = await fetch(`/api/trending?category=${category}&max_items=12`);
                const data = await response.json();
                
                if (data.success && data.items.length > 0) {
                    let html = '';
                    data.items.forEach(item => {
                        const safeTitle = item.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `
                            <div class="trending-item">
                                <div class="trending-item-rank">#${item.rank || 'N/A'}</div>
                                <div class="trending-item-title">${item.title}</div>
                                <div class="trending-item-price">$${item.price.toFixed(2)}</div>
                                <button class="search-from-trending" onclick="searchFromTrending('${safeTitle}')">
                                    üîç Search This
                                </button>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No trending items found for this category.</div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: #c33;">Error loading trending items: ${error.message}</div>`;
            }
        }
        
        async function searchFromTrending(productName) {
            console.log('üîç Searching for:', productName);
            
            // Fill search field
            document.getElementById('searchQuery').value = productName;
            
            // Get search parameters
            const maxResults = parseInt(document.getElementById('maxResults').value) || 20;
            const locationInput = document.getElementById('location').value.trim();
            const location = locationInput || null;
            
            // Show loading immediately
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            
            // Reset status indicators
            document.getElementById('statusEbay').textContent = 'üîç Searching eBay...';
            document.getElementById('statusEbay').className = 'status-item status-searching';
            document.getElementById('statusFacebook').textContent = 'üîç Searching Facebook...';
            document.getElementById('statusFacebook').className = 'status-item status-searching';
            document.getElementById('statusAmazon').textContent = 'üîç Searching Amazon...';
            document.getElementById('statusAmazon').className = 'status-item status-searching';
            
            // Scroll to loading section
            document.getElementById('loading').scrollIntoView({ behavior: 'smooth' });
            
            // Perform search directly
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: productName,
                        max_results: maxResults,
                        location: location
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Search complete:', data);
                    searchResults = data;
                    
                    // Display data quality warnings if any
                    if (data.data_quality_warnings && data.data_quality_warnings.length > 0) {
                        displayDataQualityWarnings(data.data_quality_warnings);
                    }
                    
                    // Update status indicators
                    updateSearchStatus('ebay', data.ebay.length, data.errors);
                    updateSearchStatus('facebook', data.facebook.length, data.errors);
                    updateSearchStatus('amazon', data.amazon.length, data.errors);
                    
                    // Small delay to show status, then display results
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        displayResults(data);
                        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                } else {
                    console.error('‚ùå Search failed:', data);
                    showError(data.error || 'Search failed');
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Search error:', error);
                showError('Error: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            } finally {
                document.getElementById('searchBtn').disabled = false;
            }
        }
        
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;
            
            const maxResults = parseInt(document.getElementById('maxResults').value) || 20;
            const locationInput = document.getElementById('location').value.trim();
            const location = locationInput || null;  // null if empty, will use default
            
            // Show loading with status
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            
            // Reset status indicators
            document.getElementById('statusEbay').textContent = 'üîç Searching eBay...';
            document.getElementById('statusEbay').className = 'status-item status-searching';
            document.getElementById('statusFacebook').textContent = 'üîç Searching Facebook...';
            document.getElementById('statusFacebook').className = 'status-item status-searching';
            document.getElementById('statusAmazon').textContent = 'üîç Searching Amazon...';
            document.getElementById('statusAmazon').className = 'status-item status-searching';
            
            console.log('üîç Starting search for:', query);
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        max_results: maxResults,
                        location: location
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Search complete:', data);
                    searchResults = data;
                    
                    // Display data quality warnings if any
                    if (data.data_quality_warnings && data.data_quality_warnings.length > 0) {
                        displayDataQualityWarnings(data.data_quality_warnings);
                    }
                    
                    // Update status indicators
                    updateSearchStatus('ebay', data.ebay.length, data.errors);
                    updateSearchStatus('facebook', data.facebook.length, data.errors);
                    updateSearchStatus('amazon', data.amazon.length, data.errors);
                    
                    // Small delay to show status, then display results
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        displayResults(data);
                        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                } else {
                    console.error('‚ùå Search failed:', data);
                    showError(data.error || 'Search failed');
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Search error:', error);
                showError('Error: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            } finally {
                document.getElementById('searchBtn').disabled = false;
            }
        });
        
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            
            // Display stats
            const totalItems = data.ebay.length + data.facebook.length + data.amazon.length;
            document.getElementById('stats').innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value">${totalItems}</div>
                        <div class="stat-label">Total Results</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.ebay.length}</div>
                        <div class="stat-label">eBay</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.facebook.length}</div>
                        <div class="stat-label">Facebook</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.amazon.length}</div>
                        <div class="stat-label">Amazon</div>
                    </div>
                </div>
            `;
            
            // Display errors
            if (data.errors && data.errors.length > 0) {
                document.getElementById('errors').innerHTML = `
                    <div class="error">
                        <strong>Errors:</strong><br>
                        ${data.errors.map(e => `‚Ä¢ ${e}`).join('<br>')}
                    </div>
                `;
            } else {
                document.getElementById('errors').innerHTML = '';
            }
            
            // Display results
            let resultsHTML = '';
            
            // Create comparison table
            const allItems = [
                ...data.ebay.map(i => ({...i, platform: 'eBay'})),
                ...data.facebook.map(i => ({...i, platform: 'Facebook'})),
                ...data.amazon.map(i => ({...i, platform: 'Amazon'}))
            ];
            
            // Group by title (simple grouping)
            const grouped = {};
            allItems.forEach(item => {
                const key = item.title.toLowerCase().substring(0, 40);
                if (!grouped[key]) {
                    grouped[key] = {ebay: null, facebook: null, amazon: null, title: item.title};
                }
                if (item.platform === 'eBay') grouped[key].ebay = item;
                if (item.platform === 'Facebook') grouped[key].facebook = item;
                if (item.platform === 'Amazon') grouped[key].amazon = item;
            });
            
            resultsHTML += '<h2 style="margin-bottom: 20px;">Price Comparison</h2>';
            resultsHTML += '<table class="comparison-table">';
            resultsHTML += '<thead><tr><th>Image</th><th>Product</th><th>eBay Price</th><th>Facebook Price</th><th>Amazon Price</th><th>Best Price</th><th>Links</th></tr></thead><tbody>';
            
            Object.values(grouped).forEach(group => {
                const prices = {};
                if (group.ebay) prices['eBay'] = group.ebay.all_in_cost;
                if (group.facebook) prices['Facebook'] = group.facebook.all_in_cost;
                if (group.amazon) prices['Amazon'] = group.amazon.all_in_cost;
                
                const bestPlatform = Object.keys(prices).length > 0 ? Object.keys(prices).reduce((a, b) => prices[a] < prices[b] ? a : b) : null;
                const bestPrice = bestPlatform ? prices[bestPlatform] : null;
                
                const ebayPrice = group.ebay ? `$${group.ebay.all_in_cost.toFixed(2)}` : '‚Äî';
                const fbPrice = group.facebook ? `$${group.facebook.all_in_cost.toFixed(2)}` : '‚Äî';
                const amazonPrice = group.amazon ? `$${group.amazon.all_in_cost.toFixed(2)}` : '‚Äî';
                const bestPriceDisplay = bestPrice ? `$${bestPrice.toFixed(2)} (${bestPlatform})` : '‚Äî';
                
                const rowClass = bestPlatform ? 'best-price' : '';
                
                // Get image (prefer eBay, then Facebook, then Amazon)
                let imageUrl = '';
                if (group.ebay && group.ebay.image_url) imageUrl = group.ebay.image_url;
                else if (group.facebook && group.facebook.image_url) imageUrl = group.facebook.image_url;
                else if (group.amazon && group.amazon.image_url) imageUrl = group.amazon.image_url;
                
                const imageHtml = imageUrl 
                    ? `<img src="${imageUrl}" alt="${group.title}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer;" onclick="window.open('${imageUrl}', '_blank')" title="Click to view full size">`
                    : '<div style="width: 80px; height: 80px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 10px;">No Image</div>';
                
                let links = [];
                if (group.ebay && group.ebay.url) {
                    links.push(`<a href="${group.ebay.url}" target="_blank">eBay</a>`);
                } else if (group.ebay) {
                    links.push(`<span style="color: #999; text-decoration: line-through;">eBay (no URL)</span>`);
                }
                if (group.facebook && group.facebook.url) {
                    links.push(`<a href="${group.facebook.url}" target="_blank">FB</a>`);
                } else if (group.facebook) {
                    links.push(`<span style="color: #999; text-decoration: line-through;">FB (no URL)</span>`);
                }
                if (group.amazon && group.amazon.url) {
                    links.push(`<a href="${group.amazon.url}" target="_blank">Amazon</a>`);
                } else if (group.amazon) {
                    links.push(`<span style="color: #999; text-decoration: line-through;">Amazon (no URL)</span>`);
                }
                
                resultsHTML += `<tr class="${rowClass}">`;
                resultsHTML += `<td>${imageHtml}</td>`;
                resultsHTML += `<td>${group.title.substring(0, 60)}${group.title.length > 60 ? '...' : ''}</td>`;
                resultsHTML += `<td>${ebayPrice}</td>`;
                resultsHTML += `<td>${fbPrice}</td>`;
                resultsHTML += `<td>${amazonPrice}</td>`;
                resultsHTML += `<td><strong>${bestPriceDisplay}</strong></td>`;
                resultsHTML += `<td>${links.join(' | ')}</td>`;
                resultsHTML += `</tr>`;
            });
            
            resultsHTML += '</tbody></table>';
            
            // Also show individual platform results
            resultsHTML += '<div class="platform-section">';
            resultsHTML += '<div class="platform-header"><span class="platform-badge badge-ebay">eBay</span><span>Found ' + data.ebay.length + ' items</span></div>';
            resultsHTML += '<div class="items-grid">';
            data.ebay.slice(0, 6).forEach(item => {
                resultsHTML += createItemCard(item);
            });
            resultsHTML += '</div></div>';
            
            resultsHTML += '<div class="platform-section">';
            resultsHTML += '<div class="platform-header"><span class="platform-badge badge-facebook">Facebook Marketplace</span><span>Found ' + data.facebook.length + ' items</span></div>';
            resultsHTML += '<div class="items-grid">';
            data.facebook.slice(0, 6).forEach(item => {
                resultsHTML += createItemCard(item);
            });
            resultsHTML += '</div></div>';
            
            resultsHTML += '<div class="platform-section">';
            resultsHTML += '<div class="platform-header"><span class="platform-badge badge-amazon">Amazon</span><span>Found ' + data.amazon.length + ' items</span></div>';
            resultsHTML += '<div class="items-grid">';
            data.amazon.slice(0, 6).forEach(item => {
                resultsHTML += createItemCard(item);
            });
            resultsHTML += '</div></div>';
            
            document.getElementById('results').innerHTML = resultsHTML;
        }
        
        function createItemCard(item) {
            const image = item.image_url || '';
            const hasUrl = item.url && item.url.trim();
            const linkHtml = hasUrl 
                ? `<a href="${item.url}" target="_blank" class="item-link">View ‚Üí</a>`
                : `<span style="color: #999; font-size: 0.9em;">‚ö†Ô∏è No URL available</span>`;
            return `
                <div class="item-card">
                    ${image ? `<img src="${image}" alt="${item.title}" class="item-image" onerror="this.style.display='none'">` : ''}
                    <div class="item-info">
                        <div class="item-title">${item.title}</div>
                        <div class="item-price">$${item.all_in_cost.toFixed(2)}</div>
                        ${linkHtml}
                    </div>
                </div>
            `;
        }
        
        function displayDataQualityWarnings(warnings) {
            const warningsContainer = document.getElementById('dataQualityWarnings');
            if (!warningsContainer) return;
            
            let warningsHTML = '<div class="data-quality-warnings" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0;">';
            warningsHTML += '<h3 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Data Quality Warnings</h3>';
            warningsHTML += '<ul style="margin: 0; padding-left: 20px;">';
            warnings.forEach(warning => {
                warningsHTML += `<li style="color: #856404; margin: 5px 0;">${warning}</li>`;
            });
            warningsHTML += '</ul>';
            warningsHTML += '</div>';
            
            warningsContainer.innerHTML = warningsHTML;
            warningsContainer.style.display = 'block';
        }
        
        function updateSearchStatus(platform, count, errors) {
            const statusId = `status${platform.charAt(0).toUpperCase() + platform.slice(1)}`;
            const statusEl = document.getElementById(statusId);
            
            if (!statusEl) return;
            
            const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);
            const hasError = errors && errors.some(e => e.toLowerCase().includes(platform.toLowerCase()));
            
            if (hasError) {
                statusEl.textContent = `‚ùå ${platformName} error`;
                statusEl.className = 'status-item status-error';
            } else if (count > 0) {
                statusEl.textContent = `‚úÖ ${platformName}: ${count} items`;
                statusEl.className = 'status-item status-success';
            } else {
                statusEl.textContent = `‚ö†Ô∏è ${platformName}: No results`;
                statusEl.className = 'status-item status-searching';
            }
        }
        
        function showError(message) {
            document.getElementById('errors').innerHTML = `<div class="error">${message}</div>`;
        }
        
        async function generateReport() {
            if (!searchResults) {
                alert('Please search first!');
                return;
            }
            
            const btn = document.getElementById('generateReportBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Report generated! Opening in new tab...');
                    window.open('/report/' + data.report_file.split('/').pop(), '_blank');
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate report'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate HTML Report';
            }
        }
    </script>
</body>
</html>

